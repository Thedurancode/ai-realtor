# =============================================================================
# AI REALTOR - SQLite Docker Makefile
# =============================================================================
# Convenient commands for managing AI Realtor with SQLite in Docker
# Usage: make <command>
# =============================================================================

.PHONY: help start stop restart logs build shell db-backup db-restore clean health status

# Default target
.DEFAULT_GOAL := help

# Configuration
COMPOSE_FILE := docker-compose.sqlite.yml
CONTAINER_NAME := ai-realtor-sqlite
DB_PATH := /app/data/ai_realtor.db

# Colors for output
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[1;33m
NC := \033[0m

##@ General

help: ## Display this help message
	@echo "$(BLUE)â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—$(NC)"
	@echo "$(BLUE)â•‘                                                           â•‘$(NC)"
	@echo "$(BLUE)â•‘   ðŸ  AI REALTOR - SQLite Docker Commands                  â•‘$(NC)"
	@echo "$(BLUE)â•‘                                                           â•‘$(NC)"
	@echo "$(BLUE)â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(GREEN)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""

##@ Docker Management

start: ## Start the containers
	@echo "$(BLUE)Starting AI Realtor...$(NC)"
	docker compose -f $(COMPOSE_FILE) up -d
	@echo "$(GREEN)âœ“ Started successfully$(NC)"
	@echo ""
	@echo "API: $(BLUE)http://localhost:8000$(NC)"
	@echo "Docs: $(BLUE)http://localhost:8000/docs$(NC)"
	@echo "MCP: $(BLUE)http://localhost:8001$(NC)"

stop: ## Stop the containers
	@echo "$(BLUE)Stopping AI Realtor...$(NC)"
	docker compose -f $(COMPOSE_FILE) down
	@echo "$(GREEN)âœ“ Stopped successfully$(NC)"

restart: ## Restart the containers
	@echo "$(BLUE)Restarting AI Realtor...$(NC)"
	docker compose -f $(COMPOSE_FILE) restart
	@echo "$(GREEN)âœ“ Restarted successfully$(NC)"

build: ## Rebuild the containers
	@echo "$(BLUE)Rebuilding AI Realtor...$(NC)"
	docker compose -f $(COMPOSE_FILE) up -d --build
	@echo "$(GREEN)âœ“ Built successfully$(NC)"

logs: ## View and follow logs
	docker compose -f $(COMPOSE_FILE) logs -f

logs-short: ## View last 50 lines of logs
	docker compose -f $(COMPOSE_FILE) logs --tail=50

shell: ## Open shell in container
	docker exec -it $(CONTAINER_NAME) bash

status: ## Show container status
	@echo "$(BLUE)Container Status:$(NC)"
	docker compose -f $(COMPOSE_FILE) ps
	@echo ""
	@echo "$(BLUE)Container Health:$(NC)"
	@docker inspect $(CONTAINER_NAME) 2>/dev/null | grep -A 5 '"Health"' || echo "Container not running"

health: ## Check application health
	@echo "$(BLUE)Checking application health...$(NC)"
	@curl -s http://localhost:8000/health | jq . 2>/dev/null || curl -s http://localhost:8000/health

##@ Database Operations

db-shell: ## Open SQLite shell
	docker exec -it $(CONTAINER_NAME) sqlite3 $(DB_PATH)

db-backup: ## Backup database to ./backups/
	@mkdir -p ./backups
	@echo "$(BLUE)Backing up database...$(NC)"
	docker cp $(CONTAINER_NAME):$(DB_PATH) ./backups/ai_realtor_$$(date +%Y%m%d_%H%M%S).db
	@echo "$(GREEN)âœ“ Backup created in ./backups/$(NC)"

db-restore: ## Restore database (usage: make db-restore FILE=backups/ai_realtor_20240224.db)
	@if [ -z "$(FILE)" ]; then \
		echo "$(YELLOW)Usage: make db-restore FILE=backups/ai_realtor_20240224.db$(NC)"; \
		exit 1; \
	fi
	@echo "$(BLUE)Restoring database from $(FILE)...$(NC)"
	docker cp $(FILE) $(CONTAINER_NAME):$(DB_PATH)
	docker compose -f $(COMPOSE_FILE) restart
	@echo "$(GREEN)âœ“ Database restored$(NC)"

db-info: ## Show database information
	@echo "$(BLUE)Database Information:$(NC)"
	@echo ""
	@echo "Tables:"
	@docker exec $(CONTAINER_NAME) sqlite3 $(DB_PATH) "SELECT COUNT(*) as table_count FROM sqlite_master WHERE type='table';" 2>/dev/null || echo "  Database not accessible"
	@echo ""
	@echo "Database size:"
	@docker exec $(CONTAINER_NAME) ls -lh $(DB_PATH) 2>/dev/null | awk '{print "  " $$5}' || echo "  Unable to determine size"

db-migrate: ## Run database migrations
	docker exec $(CONTAINER_NAME) alembic upgrade head

##@ Development

dev: ## Start with live code reload
	@echo "$(BLUE)Starting in development mode...$(NC)"
	docker compose -f $(COMPOSE_FILE) up

test: ## Run tests
	docker exec $(CONTAINER_NAME) pytest -v

deps: ## Install/upgrade Python dependencies
	docker exec $(CONTAINER_NAME) pip install --upgrade -r requirements.txt

##@ Cleanup

clean: ## Stop and remove containers, volumes, and images
	@echo "$(YELLOW)This will remove all containers, volumes, and images!$(NC)"
	@read -p "Are you sure? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		docker compose -f $(COMPOSE_FILE) down -v --rmi all; \
		echo "$(GREEN)âœ“ Cleaned$(NC)"; \
	else \
		echo "Aborted"; \
	fi

clean-data: ## Remove database volume (âš ï¸ deletes all data!)
	@echo "$(YELLOW)âš ï¸  This will delete all data!$(NC)"
	@read -p "Are you sure? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		docker compose -f $(COMPOSE_FILE) down -v; \
		docker volume rm ai_realtor_sqlite_data 2>/dev/null || true; \
		echo "$(GREEN)âœ“ Data deleted$(NC)"; \
	else \
		echo "Aborted"; \
	fi

##@ Utilities

update: ## Pull latest code and rebuild
	@echo "$(BLUE)Updating AI Realtor...$(NC)"
	git pull
	docker compose -f $(COMPOSE_FILE) build
	docker compose -f $(COMPOSE_FILE) up -d
	@echo "$(GREEN)âœ“ Updated$(NC)"

setup: ## First-time setup
	@echo "$(BLUE)Running first-time setup...$(NC)"
	@chmod +x docker-quick-start-sqlite.sh
	@chmod +x start-sqlite.sh
	@chmod +x start.sh
	@echo "$(GREEN)âœ“ Setup complete$(NC)"
	@echo ""
	@echo "$(YELLOW)Next steps:$(NC)"
	@echo "  1. Create a .env file with your API keys"
	@echo "  2. Run: make start"
	@echo "  3. Open: http://localhost:8000/docs"

docs: ## Open API documentation
	@echo "$(BLUE)Opening API documentation...$(NC)"
	@open http://localhost:8000/docs 2>/dev/null || xdg-open http://localhost:8000/docs 2>/dev/null || echo "Open http://localhost:8000/docs in your browser"
