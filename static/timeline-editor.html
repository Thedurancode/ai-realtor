<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline Video Editor - AI Realtor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a1a1a;
            color: #fff;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 300px;
            background: #2a2a2a;
            padding: 20px;
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        h1, h2, h3 {
            margin-bottom: 15px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #aaa;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            border-radius: 5px;
            color: #fff;
            font-size: 14px;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #007bff;
        }

        button {
            padding: 10px 20px;
            background: #007bff;
            border: none;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background: #0056b3;
        }

        button.secondary {
            background: #6c757d;
        }

        button.secondary:hover {
            background: #545b62;
        }

        button.success {
            background: #28a745;
        }

        button.success:hover {
            background: #218838;
        }

        .preview-area {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .preview-container {
            flex: 1;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
        }

        .preview-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 14px;
        }

        .timeline-container {
            background: #2a2a2a;
            border-radius: 10px;
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .track {
            margin-bottom: 20px;
        }

        .track-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .track-label {
            width: 100px;
            font-size: 14px;
            font-weight: bold;
        }

        .track-timeline {
            flex: 1;
            background: #1a1a1a;
            height: 60px;
            position: relative;
            border-radius: 5px;
        }

        .clip {
            position: absolute;
            height: 50px;
            top: 5px;
            background: #007bff;
            border-radius: 5px;
            cursor: move;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 12px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .clip.video { background: #007bff; }
        .clip.image { background: #28a745; }
        .clip.text { background: #ffc107; color: #000; }

        .clip-controls {
            position: absolute;
            top: -25px;
            left: 0;
            background: #3a3a3a;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 11px;
            display: none;
        }

        .clip:hover .clip-controls {
            display: block;
        }

        .add-clip-form {
            background: #3a3a3a;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .clip-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .clip-item {
            background: #3a3a3a;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .clip-info {
            flex: 1;
        }

        .clip-type {
            font-size: 12px;
            color: #aaa;
        }

        .time-ruler {
            display: flex;
            margin-bottom: 10px;
            font-size: 12px;
            color: #666;
        }

        .time-marker {
            flex: 1;
            text-align: center;
        }

        .saved-projects {
            margin-top: 20px;
        }

        .project-item {
            background: #3a3a3a;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .project-item:hover {
            background: #4a4a4a;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #aaa;
        }

        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .status-message.success {
            background: #28a745;
            color: #fff;
        }

        .status-message.error {
            background: #dc3545;
            color: #fff;
        }

        .status-message.info {
            background: #17a2b8;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>üé¨ Video Editor</h2>

            <div id="status-message"></div>

            <div class="input-group">
                <label>Project Name</label>
                <input type="text" id="project-name" placeholder="My Property Video" />
            </div>

            <div class="input-group">
                <label>Description</label>
                <textarea id="project-description" rows="3" placeholder="Property tour video..."></textarea>
            </div>

            <div class="input-group">
                <label>Duration (seconds)</label>
                <input type="number" id="duration" value="30" min="5" max="300" />
            </div>

            <div class="input-group">
                <label>Resolution</label>
                <select id="resolution">
                    <option value="1080x1920">1080x1920 (Vertical)</option>
                    <option value="1920x1080">1920x1080 (Horizontal)</option>
                    <option value="1080x1080">1080x1080 (Square)</option>
                </select>
            </div>

            <button onclick="saveProject()" class="success">üíæ Save Project</button>
            <button onclick="loadProjects()">üìÇ Load Projects</button>
            <button onclick="renderVideo()" class="success">üé¨ Render Video</button>

            <div class="saved-projects" id="saved-projects"></div>
        </div>

        <div class="main-content">
            <div class="preview-area">
                <div class="preview-container">
                    <div class="preview-placeholder">
                        Preview will appear here
                    </div>
                </div>
            </div>

            <div class="timeline-container">
                <h3>Timeline</h3>

                <div class="time-ruler" id="time-ruler"></div>

                <div id="tracks"></div>

                <div class="add-clip-form">
                    <h3>Add Clip</h3>
                    <div class="input-group">
                        <label>Track Type</label>
                        <select id="clip-track-type" onchange="updateClipForm()">
                            <option value="video">üé• Video</option>
                            <option value="image">üñºÔ∏è Image</option>
                            <option value="text">üìù Text</option>
                        </select>
                    </div>

                    <div class="input-group" id="clip-src-group">
                        <label>Source URL</label>
                        <input type="text" id="clip-src" placeholder="https://example.com/image.jpg" />
                    </div>

                    <div class="input-group" id="clip-text-group" style="display: none;">
                        <label>Text Content</label>
                        <input type="text" id="clip-text" placeholder="Property Title" />
                    </div>

                    <div class="input-group">
                        <label>Start (seconds)</label>
                        <input type="number" id="clip-start" value="0" min="0" />
                    </div>

                    <div class="input-group">
                        <label>Duration (seconds)</label>
                        <input type="number" id="clip-duration" value="3" min="1" />
                    </div>

                    <div class="input-group">
                        <label>Transition</label>
                        <select id="clip-transition">
                            <option value="none">None</option>
                            <option value="fade">Fade</option>
                            <option value="slide">Slide</option>
                            <option value="zoom">Zoom</option>
                        </select>
                    </div>

                    <button onclick="addClip()" class="success">‚ûï Add Clip</button>
                </div>

                <div class="clip-list" id="clip-list"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let currentProject = null;
        let tracks = {
            video: [],
            image: [],
            text: []
        };

        // Get API key from localStorage or prompt
        function getApiKey() {
            let apiKey = localStorage.getItem('api_key');
            if (!apiKey) {
                apiKey = prompt('Enter your API key:');
                if (apiKey) {
                    localStorage.setItem('api_key', apiKey);
                }
            }
            return apiKey;
        }

        // Show status message
        function showMessage(message, type = 'info') {
            const el = document.getElementById('status-message');
            el.innerHTML = `<div class="status-message ${type}">${message}</div>`;
            setTimeout(() => el.innerHTML = '', 5000);
        }

        // Update clip form based on track type
        function updateClipForm() {
            const type = document.getElementById('clip-track-type').value;
            document.getElementById('clip-src-group').style.display = type === 'text' ? 'none' : 'block';
            document.getElementById('clip-text-group').style.display = type === 'text' ? 'block' : 'none';
        }

        // Add clip to timeline
        function addClip() {
            const trackType = document.getElementById('clip-track-type').value;
            const src = document.getElementById('clip-src').value;
            const text = document.getElementById('clip-text').value;
            const start = parseInt(document.getElementById('clip-start').value) * 30; // Convert to frames
            const duration = parseInt(document.getElementById('clip-duration').value) * 30; // Convert to frames
            const transition = document.getElementById('clip-transition').value;

            const clip = {
                id: 'clip_' + Date.now(),
                start,
                duration,
                type: trackType,
                src: trackType !== 'text' ? src : null,
                text: trackType === 'text' ? text : null,
                transition
            };

            tracks[trackType].push(clip);
            renderTimeline();
            updateClipList();
            showMessage('Clip added!', 'success');
        }

        // Remove clip
        function removeClip(trackType, clipId) {
            tracks[trackType] = tracks[trackType].filter(c => c.id !== clipId);
            renderTimeline();
            updateClipList();
        }

        // Render timeline
        function renderTimeline() {
            const duration = parseInt(document.getElementById('duration').value) * 30;
            const container = document.getElementById('tracks');
            const resolution = document.getElementById('resolution').value.split('x');

            // Render time ruler
            const ruler = document.getElementById('time-ruler');
            ruler.innerHTML = '';
            for (let i = 0; i <= duration; i += 30) {
                const marker = document.createElement('div');
                marker.className = 'time-marker';
                marker.textContent = (i / 30) + 's';
                ruler.appendChild(marker);
            }

            // Render tracks
            container.innerHTML = '';
            Object.entries(tracks).forEach(([trackType, clips]) => {
                if (clips.length === 0) return;

                const trackDiv = document.createElement('div');
                trackDiv.className = 'track';

                const labels = {
                    video: 'üé• Video',
                    image: 'üñºÔ∏è Image',
                    text: 'üìù Text'
                };

                trackDiv.innerHTML = `
                    <div class="track-header">
                        <div class="track-label">${labels[trackType]}</div>
                        <div class="track-timeline">
                            ${clips.map(clip => {
                                const left = (clip.start / duration) * 100;
                                const width = (clip.duration / duration) * 100;
                                const label = clip.type === 'text' ? clip.text : clip.src.split('/').pop();
                                return `
                                    <div class="clip ${clip.type}" style="left: ${left}%; width: ${width}%; max-width: 200px;">
                                        <span>${label}</span>
                                        <div class="clip-controls">
                                            <button onclick="removeClip('${trackType}', '${clip.id}')" style="padding: 2px 5px; font-size: 10px;">‚úï</button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
                container.appendChild(trackDiv);
            });
        }

        // Update clip list
        function updateClipList() {
            const container = document.getElementById('clip-list');
            container.innerHTML = '';

            Object.entries(tracks).forEach(([trackType, clips]) => {
                clips.forEach(clip => {
                    const div = document.createElement('div');
                    div.className = 'clip-item';
                    const label = clip.type === 'text' ? clip.text : clip.src;
                    div.innerHTML = `
                        <div class="clip-info">
                            <strong>${clip.type}</strong>: ${label.substring(0, 50)}...
                            <br>
                            <span class="clip-type">${clip.start / 30}s - ${(clip.start + clip.duration) / 30}s ‚Ä¢ ${clip.transition}</span>
                        </div>
                        <button onclick="removeClip('${trackType}', '${clip.id}')" class="secondary" style="margin: 0; padding: 5px 10px;">‚úï</button>
                    `;
                    container.appendChild(div);
                });
            });
        }

        // Save project
        async function saveProject() {
            const name = document.getElementById('project-name').value || 'Untitled Project';
            const description = document.getElementById('project-description').value;
            const duration = parseInt(document.getElementById('duration').value) * 30;
            const [width, height] = document.getElementById('resolution').value.split('x').map(Number);

            const timelineData = {
                tracks: Object.entries(tracks).map(([type, clips]) => ({
                    id: type,
                    type,
                    clips
                })),
                duration
            };

            const data = {
                name,
                description,
                timeline_data: timelineData,
                fps: 30,
                width,
                height
            };

            try {
                const apiKey = getApiKey();
                const response = await fetch(`${API_BASE}/v1/timeline`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    currentProject = result;
                    showMessage('Project saved!', 'success');
                } else {
                    const error = await response.json();
                    showMessage('Error: ' + error.detail, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        // Load projects
        async function loadProjects() {
            try {
                const apiKey = getApiKey();
                const response = await fetch(`${API_BASE}/v1/timeline`, {
                    headers: {
                        'X-API-Key': apiKey
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    const container = document.getElementById('saved-projects');
                    container.innerHTML = '<h3>Saved Projects</h3>';

                    result.projects.forEach(project => {
                        const div = document.createElement('div');
                        div.className = 'project-item';
                        div.innerHTML = `
                            <strong>${project.name}</strong>
                            <br><small>${new Date(project.created_at).toLocaleDateString()}</small>
                        `;
                        div.onclick = () => loadProjectDetails(project.id);
                        container.appendChild(div);
                    });

                    showMessage('Projects loaded!', 'success');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        // Load project details
        async function loadProjectDetails(projectId) {
            try {
                const apiKey = getApiKey();
                const response = await fetch(`${API_BASE}/v1/timeline/${projectId}`, {
                    headers: {
                        'X-API-Key': apiKey
                    }
                });

                if (response.ok) {
                    const project = await response.json();
                    currentProject = project;

                    // Populate form
                    document.getElementById('project-name').value = project.name;
                    document.getElementById('project-description').value = project.description || '';
                    document.getElementById('duration').value = project.timeline_data.duration / 30;
                    document.getElementById('resolution').value = `${project.width}x${project.height}`;

                    // Load tracks
                    tracks = { video: [], image: [], text: [] };
                    project.timeline_data.tracks.forEach(track => {
                        if (tracks[track.type]) {
                            tracks[track.type] = track.clips;
                        }
                    });

                    renderTimeline();
                    updateClipList();
                    showMessage('Project loaded!', 'success');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        // Render video
        async function renderVideo() {
            if (!currentProject) {
                showMessage('Please save the project first', 'error');
                return;
            }

            try {
                const apiKey = getApiKey();
                const response = await fetch(`${API_BASE}/v1/timeline/${currentProject.id}/render`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': apiKey
                    },
                    body: JSON.stringify({})
                });

                if (response.ok) {
                    const job = await response.json();
                    showMessage(`Render started! Job ID: ${job.id}`, 'success');
                    // You can poll for progress using the renders API
                } else {
                    const error = await response.json();
                    showMessage('Error: ' + error.detail, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        // Initialize
        renderTimeline();
    </script>
</body>
</html>
